<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kiá»ƒm tra Frontend JobVerse</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0a0a0b;
      color: #fff;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #1a1a1b;
      border: 1px solid #333;
    }
    .success { border-color: #10b981; background: #10b98120; }
    .error { border-color: #ef4444; background: #ef444420; }
    .warning { border-color: #f59e0b; background: #f59e0b20; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      font-weight: 600;
    }
    button:hover { opacity: 0.9; }
    code {
      background: #000;
      padding: 2px 6px;
      border-radius: 4px;
      color: #10b981;
    }
    pre {
      background: #000;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” Kiá»ƒm tra Frontend JobVerse</h1>
  <p>CÃ´ng cá»¥ nÃ y sáº½ giÃºp báº¡n kiá»ƒm tra cÃ¡c váº¥n Ä‘á» vá»›i frontend.</p>

  <div id="results"></div>

  <h2>ğŸ§ª CÃ¡c bÃ i test</h2>
  <button onclick="testAuth()">1. Kiá»ƒm tra Authentication</button>
  <button onclick="testSaveJob()">2. Test Save Job (Job #482)</button>
  <button onclick="testQuickApply()">3. Test Quick Apply (Job #483)</button>
  <button onclick="clearCache()">4. XÃ³a Cache & Reload</button>

  <script>
    const API_BASE_URL = 'http://localhost:8080/api';
    const results = document.getElementById('results');

    function log(message, type = 'status') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
    }

    function testAuth() {
      results.innerHTML = '';
      log('ğŸ” Äang kiá»ƒm tra authentication...', 'status');

      const token = localStorage.getItem('accessToken');
      const user = localStorage.getItem('user');

      if (!token) {
        log('âŒ KHÃ”NG TÃŒM THáº¤Y TOKEN trong localStorage!<br>Báº¡n cáº§n Ä‘Äƒng nháº­p láº¡i.', 'error');
        return;
      }

      log('âœ… Token tá»“n táº¡i: <code>' + token.substring(0, 30) + '...</code>', 'success');

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const exp = new Date(payload.exp * 1000);
        const now = new Date();

        if (now > exp) {
          log('âŒ Token ÄÃƒ Háº¾T Háº N! Exp: ' + exp.toLocaleString(), 'error');
        } else {
          log('âœ… Token cÃ²n háº¡n Ä‘áº¿n: ' + exp.toLocaleString(), 'success');
        }

        log('ğŸ“§ Email: <code>' + payload.sub + '</code>', 'success');
      } catch (e) {
        log('âš ï¸ KhÃ´ng thá»ƒ decode token: ' + e.message, 'warning');
      }

      if (user) {
        try {
          const userObj = JSON.parse(user);
          log('ğŸ‘¤ User ID: <code>' + userObj.id + '</code>', 'success');
          log('ğŸ“ TÃªn: <code>' + (userObj.fullName || userObj.email) + '</code>', 'success');
        } catch (e) {
          log('âš ï¸ KhÃ´ng thá»ƒ parse user data', 'warning');
        }
      }
    }

    async function testSaveJob() {
      results.innerHTML = '';
      log('ğŸ’¾ Äang test Save Job API...', 'status');

      const token = localStorage.getItem('accessToken');
      if (!token) {
        log('âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p!', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/v1/saved-jobs/484`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          log('âœ… SAVE JOB THÃ€NH CÃ”NG!<br><pre>' + JSON.stringify(data, null, 2) + '</pre>', 'success');
        } else {
          log('âŒ Lá»–I: ' + (data.error?.message || 'Unknown error') + '<br><pre>' + JSON.stringify(data, null, 2) + '</pre>', 'error');
        }
      } catch (error) {
        log('âŒ NETWORK ERROR: ' + error.message, 'error');
      }
    }

    async function testQuickApply() {
      results.innerHTML = '';
      log('âš¡ Äang test Quick Apply API...', 'status');

      const token = localStorage.getItem('accessToken');
      if (!token) {
        log('âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p!', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/v1/applications/quick-apply/485`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          log('âœ… QUICK APPLY THÃ€NH CÃ”NG!<br><pre>' + JSON.stringify(data, null, 2) + '</pre>', 'success');
        } else {
          if (data.error?.message?.includes('already applied')) {
            log('âš ï¸ Báº¡n Ä‘Ã£ á»©ng tuyá»ƒn job nÃ y rá»“i (Ä‘Ã¢y lÃ  lá»—i há»£p lá»‡)<br><pre>' + JSON.stringify(data, null, 2) + '</pre>', 'warning');
          } else {
            log('âŒ Lá»–I: ' + (data.error?.message || 'Unknown error') + '<br><pre>' + JSON.stringify(data, null, 2) + '</pre>', 'error');
          }
        }
      } catch (error) {
        log('âŒ NETWORK ERROR: ' + error.message, 'error');
      }
    }

    function clearCache() {
      results.innerHTML = '';
      log('ğŸ§¹ Äang xÃ³a cache...', 'status');

      // Clear service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(reg => {
            reg.unregister();
            log('âœ… ÄÃ£ unregister service worker', 'success');
          });
        });
      }

      // Clear cache storage
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => {
            caches.delete(name);
            log('âœ… ÄÃ£ xÃ³a cache: ' + name, 'success');
          });
        });
      }

      log('âœ… Cache Ä‘Ã£ Ä‘Æ°á»£c xÃ³a!', 'success');
      log('â³ Sáº½ reload trang sau 2 giÃ¢y...', 'warning');

      setTimeout(() => {
        window.location.reload(true);
      }, 2000);
    }

    // Auto-run auth check on load
    window.onload = () => {
      log('ğŸŒ URL hiá»‡n táº¡i: <code>' + window.location.href + '</code>', 'status');
      log('ğŸ¯ API Base URL: <code>' + API_BASE_URL + '</code>', 'status');
      log('', 'status');
      testAuth();
    };
  </script>
</body>
</html>
